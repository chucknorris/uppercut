<?xml version="1.0" encoding="utf-8" ?>
<project name="ManifestBuilder" default="go">
  <!-- Project UppercuT - http://projectuppercut.org -->
  <!-- DO NOT EDIT THIS FILE - Add custom tasks in BuildTasks.Custom folder with file by the same name - find out more at http://uppercut.pbwiki.com -->
  <property name="build.config.settings" value="__NONE__" overwrite="false" />
  <include buildfile="${build.config.settings}" if="${file::exists(build.config.settings)}" />
  <property name="path.separator" value="${string::trim(path::combine(' ', ' '))}" />
  <property name="dirs.current.file" value="${directory::get-parent-directory(project::get-buildfile-path())}" />
  <include buildfile="${dirs.current.file}${path.separator}default.build.settings" />
  <property name="build.step.name" value="${project::get-name()}" />
  <property name="build.step.path" value="${project::get-buildfile-path()}" />
  <!-- build step customizations below this -->

  <property name="msbuild.platform" value="x86" overwrite="false" />
  <property name="framework.multitargeting" value="false" />
  <property name="framework.multitargeting.delimiter" value="," />
  <property name="dirs.source" value="${dirs.current}${path.separator}${path_to_solution}${path.separator}" />

  <target name="go" depends="load_uppercut_assemblies, run_tasks" />

  <target name="run_normal_tasks"
      depends="apply_manifest"
      description="Updating application manifest."
      if="${run.manifestbuilder}" />

  <target name="apply_manifest">
    <echo message="Scanning ${path::get-full-path(dirs.source)} for app.manifest" />
    <foreach item="File" property="filename">
      <in>
        <items>
          <include name="${dirs.source}${path.separator}**${path.separator}App.manifest" />
        </items>
      </in>
      <do>
        <echo message="Updating ${filename}" />
        <xmlpoke file="${filename}"
          xpath="/asmv1:assembly/asmv1:assemblyIdentity/@processorArchitecture"
          value="${msbuild.platform}">
          <namespaces>
            <namespace prefix="asmv1" uri="urn:schemas-microsoft-com:asm.v1" />
          </namespaces>
        </xmlpoke>
        <xmlpoke file="${filename}"
          xpath="/asmv1:assembly/asmv1:assemblyIdentity/@version"
          value="${version.file}">
          <namespaces>
            <namespace prefix="asmv1" uri="urn:schemas-microsoft-com:asm.v1" />
          </namespaces>
        </xmlpoke>
      </do>
    </foreach>
  </target>

</project>
